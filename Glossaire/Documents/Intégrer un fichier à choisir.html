<html><head><meta name="qrichtext" content="charset=utf-8" /></head><body style="font-size:10pt;font-family:Sans">
<p><span style="font-family:Courier New;color:#ffffff">{{REM= Principe général : fournir un fichier temporaire, toujours nommé de la meme façon, et généré par le scanner dans un blackhole ; la sortie sera un fichier rangé dans un dossier patient et nommé de manière unique et un lien dans un document, dans le dossier patient, permettant aux utilisateurs finaux de visualiser le PDF par un simple clic droit sur un développement de Jocelyn Perruchet}}{{\<br />{{REM= Modifications par Maxime MICLO le 09/03/2015 }}\</span><span style="font-family:Courier New"><br />{{REM= ~~~~~~~~~~~TODO~~~~~~~~~~~~~ }}\<br />{{REM= !!!!!!!!!!!!!BUG&gt;&gt; There is an issue with the two first lines and wants them absolutely. Without them we have no way to display the right things. Also it displays a backslash on first line, so we need to format these two lines in white color }}\<br />{{REM= ~~~~~~~~~~~END TODO~~~~~~~~~~~~~ }}\<br />{{REM=	Integrate a file on-demand}}\<br />{{REM=	pick up a file ; the output is a file stored in patient file directory and named uniquely with a link in a document in the patient record, enabling end users to view the PDF by simply right-clicking}}\<br />{{REM=	Author&gt;&gt; Maxime MICLO @maxime [dot] miclo [at] gmail [dot] com }}\<br />{{REM=	######VAR##### }}\<br />{{REM=	Default location to open to pick up files }}\<br />{{:: SET_VAR(defaultLocation, /opt/medintux-amd64/Programmes/tmp)}}\<br />{{REM= ~~~~~~~~~~~TODO~~~~~~~~~~~~~ }}\<br />{{REM= !!!!!!!!!!!!!BUG&gt;&gt; we can't declare final path }}\<br />{{REM= ~~~~~~~~~~~END TODO~~~~~~~~~~~~~ }}\<br />{{REM= !!!!!DEACTIVATED!!!!! SET_VAR(PatientFilePath,../../../PatientFiles)}}\<br />{{REM= We initialize list results at false }}\<br />{{:: SET_VAR(retour_de_liste,Rejected)}}\<br />{{REM= List of document types. It is necessary to separate each option with a &quot;|&quot; also the list must be ended with this one }}\<br />{{:: SET_VAR(LIST_DocType,Hospitalisation|Consultation Spécialisée|Examen Complémentaire|Courrier|)}}\<br />{{REM= List of specialities. It is necessary to separate each option with a &quot;|&quot; also the list must be ended with this one }}\<br />{{:: SET_VAR(LIST_Discipline,Administratif-Social|Angiologie|Cardiologie|Dermatologie|Hépato-Gastro-Entérologie|Endocrinologie-Métabolisme-Nutrition|Gynécologie-Obstétrique|Maladies Infectieuses|Neurologie|Oncologie|Ophtalmologie|ORL|Orthopédie|Pneumologie|Prévention|Psychiatrie|Urologie|Vaccination|Autre|) }}\<br />{{REM=	#####END VAR##### }}\<br />{{REM=	If SCRIPT_STATUS has the value FUSION_ADD or FUSION_CREATE, which is right if we create a document, validAction variable takes no value if not it takes VA0. We prefix almost all instructions with validAction so if we are in preview mode, instructions will be prefixed and not recognized }}\<br />{{:: SI(S,{{VAR=$SCRIPT_STATUS}},%%,$FUSION_ADD, ,{{:: SI(S,{{VAR=$SCRIPT_STATUS}},%%,$FUSION_CREATE,,VA0)}})&gt;validAction}}\<br />{{REM=	Opening a dialog box to choose the file }}\<br />{{:: {{VAR = validAction}}DO_LISTE(Image|PDF| , Type de document ,|, retour_de_liste)&gt;TypeDoc}}\<br />{{:: SI(S,{{VAR=retour_de_liste}},=,Rejected,VA0,{{VAR = validAction}})&gt;validAction}}\<br />{{:: {{VAR = validAction}}SI(S,{{VAR = retour_de_liste}},=,Image,{{:: OPEN_FILE_NAME(Fichiers IMAGES [*.jpg *.jpeg *.png *.gif *.JPEG *.JPG *.PNG *.GIF], {{VAR = defaultLocation}})&gt;pickedupFile}},{{:: OPEN_FILE_NAME(Fichiers PDF [*.pdf *.PDF], {{VAR = defaultLocation}})&gt;pickedupFile}})}}\<br />{{:: SI(S,{{FE={{VAR = pickedupFile}}}},=,,,VA0)&gt;pdf_ValidPopupNoFile}}\<br />{{:: SI(S,{{FE={{VAR = pickedupFile}}}},=,,VA0,{{VAR = validAction}})&gt;validAction}}\<br />{{REM=	we test TypeDoc before to reaffect it to know if we must execute instructions for PDF or not }}\<br />{{:: SI(S, {{VAR = TypeDoc}},=,PDF,,PVA0)&gt;pdfAction}}\<br />{{REM= ~~~~~~~~~~~TODO~~~~~~~~~~~~~ }}\<br />{{REM= Find a way to add an option to permit to add some text to the document title }}\<br />{{REM= ~~~~~~~~~~~END TODO~~~~~~~~~~~~~ }}\<br />{{:: {{VAR = validAction}}DO_LISTE({{VAR = LIST_DocType}} , Type de document ,|, retour_de_liste)&gt;TypeDoc}}\<br />{{:: SI(S,{{VAR=retour_de_liste}},=,Rejected,VA0,{{VAR = validAction}})&gt;validAction}}\<br />{{:: {{VAR = validAction}}DO_LISTE({{VAR = LIST_Discipline}} ,Spécialité ,|, retour_de_liste)&gt;Discipline}}\<br />{{:: SI(S,{{VAR=retour_de_liste}},=,Rejected,VA0,{{VAR = validAction}})&gt;validAction}}\<br />{{REM= We test the OS constant, and create a variable for each of them. We prefix OS specific instructions with the associated variable, if it's the good one, it has no value and if not it has one, so instructions won't be recognized because they will be prefixed }}\<br />{{:: {{VAR = pdfAction}}{{VAR = validAction}}TEST(S,{{OS}},=,L,{{VAR=toDo}},NO_LIN)&gt;toDoL}}\<br />{{REM= ~~~~~~~~~~~TODO~~~~~~~~~~~~~ }}\<br />{{REM=	Windows cases (preview &amp; patient file directory)&gt;&gt; {{VAR = pdfAction}}{{VAR = validAction}}TEST(S,{{OS}},=,W,{{VAR=toDo}},NO_WIN)&gt;toDoW}}\<br />{{REM= ~~~~~~~~~~~END TODO~~~~~~~~~~~~~ }}\<br />{{:: {{VAR = pdfAction}}{{VAR = validAction}}TEST(S,{{OS}},=,M,{{VAR=toDo}},NO_MAC)&gt;toDoM}}\<br />{{REM=	 For Mac OS X we use bash because other shells can be version specifics // Sips is an apple tool fitting perfectly for our usage. It converts only the first page to PNG if we don't use anymore parameter }}\<br />{{:: {{VAR = toDoM}}{{VAR = pdfAction}}{{VAR = validAction}}exe_process (WaitEnd, /bin/bash, &quot;sips -s format png {{VAR = pickedupFile}} --out $ToAbsPath ../../tmp/preview_pdf.png&quot;)}}\<br />{{REM= It is necessary to install ImageMagick for Linux compatibility }}\<br />{{:: {{VAR = toDoL}}{{VAR = pdfAction}}{{VAR = validAction}}exe_process (WaitEnd, /usr/bin/convert, convert,-density,150,-trim, $ToAbsPath {{VAR = pickedupFile}}[0],-quality,100,-sharpen,0x1.0, $ToAbsPath ../../tmp/preview_pdf.png)}}\<br />{{REM= We create patient file directory if it doesn't exist }}\<br />{{REM= The command is the same for Linux and Mac so we test the Windows prefix }}\<br />{{:: SI(S,{{VAR=toDoW}},=,NO_WIN,{{:: {{VAR = validAction}}exe_process (WaitEnd, /bin/bash, mkdir,-p,$ToAbsPath ../../../PatientFiles/{{GET_DOSS_GUID}})}},)}}\<br />{{REM= We generate the final file name }}\<br />{{:: {{VAR = validAction}}SET_VAR(NomFichierDst, {{GET_DOSS_GUID}}_{{VAR = TypeDoc}}_{{VAR = Discipline}}_{{DATE = yyyyMMdd}}_{{HeureCourante = hhmmss}}.pdf)}}\<br />{{REM= We format NomFichierDist in white color so it won't be displayed which has no interest for end user }}\</span><span style="font-family:Fixed;font-size:9pt;font-weight:600;color:#aa0000"><br /></span><span style="font-family:Fixed;font-size:9pt;font-weight:600">{{::#SI(S,{{FE={{VAR  = pickedupFile}}}},=,,Aucun fichier valide n'a été sélectionné,</span><span style="font-family:Fixed;font-size:9pt;font-weight:600;text-decoration:underline;color:#0000ff">Clic droit pour voir ce fichier PDF</span><span style="font-family:Fixed;font-size:9pt;font-weight:600"> </span><span style="font-family:Fixed;font-size:9pt;font-weight:600;color:#ffffff">{{VAR = NomFichierDst}}</span><span style="font-family:Fixed;font-size:9pt;font-weight:600">)&gt;pdf_MessageFinal}}\</span><span style="font-family:Fixed;font-size:9pt;font-weight:600;color:#aa0000"><br /></span><span style="font-family:Courier New">{{REM= ~~~~~~~~~~~TODO~~~~~~~~~~~~~ }}\<br />{{REM= !!!!!!!!!!!!!BUG&gt;&gt; If the patient file directory is newly created the copy doesn't function and we lose original and final file, but the preview is perfectly stored in... }}\<br />{{REM= ~~~~~~~~~~~END TODO~~~~~~~~~~~~~ }}\<br />{{:: {{VAR = validAction}}copy_file($ToAbsPath {{VAR = pickedupFile}},$ToAbsPath ../../../PatientFiles/{{GET_DOSS_GUID}}/{{VAR = NomFichierDst}}, $remove_src_file)}}\<br />{{REM= ~~~~~~~~~~~TODO~~~~~~~~~~~~~ }}\<br />{{REM= !!!!!!!!!!!!!BUG&gt;&gt; Flags for creating/modifying/adding seems to be always on when we are adding }}\<br />{{REM= ~~~~~~~~~~~END TODO~~~~~~~~~~~~~ }}\<br />{{REM= We give a name to the document only if we creating a new one }}\<br />{{:: {{VAR = validAction}}SI(S,{{VAR=$SCRIPT_STATUS}},%%,$FUSION_ADD_Ajouter,,{{:: Intitule({{VAR = TypeDoc}} {{VAR = Discipline}})}}}})}}\<br />{{REM= Text to display in popup if this script didn't found tmpFile }}\<br />{{:: {{VAR = pdf_ValidPopupNoFile}}MESSAGE_POPUP ({{VAR=pdf_MessageFinal}})}}\</span><span style="font-family:Fixed;font-size:9pt;font-weight:600"><br /></span><hr><span style="font-family:Courier New;font-size:20pt;font-weight:600">{{VAR = TypeDoc}} {{VAR = Discipline}}</span><br /><hr>{{:: SI(S,<span style="font-family:Fixed;font-size:9pt;font-weight:600;color:#aa0000">{{VAR = pdfAction}},=,PVA0,{{::insert_image ({{VAR = pickedupFile}},1000,1000,clear_src new remove_src,../../../PatientFiles/{{GET_DOSS_GUID}})}},{{::insert_image (../../tmp/preview_pdf.png,1000,1000,clear_src new remove_src,../../../PatientFiles/{{GET_DOSS_GUID}})}}</span><br /><hr>{{::#SI(S,{{VAR = pdfAction}},=,PVA0,,<img src=pdfLies.png ><span style="font-family:Fixed;font-size:9pt;font-weight:600">{{VAR=pdf_MessageFinal}})}}\</span><br /></p>
</body></html>
