<html><head><meta name="qrichtext" content="charset=utf-8" /></head>
<body bgcolor="#ffffff" style="font-size:10pt;font-family:Sans">
<p><span style="font-family:Courier New">{{REM=	Include PDF}}
{{REM=	This macro looks for a temporary file named include_pdf.tmp.pdf. We make several operations to permit to inject some elements in documents whatever their section is. At the end we copy the pdf in patient files' directory and provide two links : one for local access and another for remotes. This macro doesn't print any information in documents, it returns only values to use in other macros}}
{{REM= ###TODO### insert line_edit to prompt user for filename >>> document title}}
{{:: WAIT_CURSOR (WAIT) }}

{{REM= ###TODO### Warn user we need to save before to execute this macro}}
{{REM= VALIDER_DOSSIER}}

{{REM= we test if the temporary file is in the tmp directory}}
{{:: SI(S,{{FE={{VAR=tmpFiles}}/include_pdf.tmp.pdf}},=,,FLAG_FALSE,)&gt;validAction}}
{{:: TEST(S,{{VAR=validAction}},=,FLAG_FALSE,ERREUR !!! Fichier temporaire absent,TEST)&gt;popupText}}

{{REM= preview and OCR instructions are system dependent so we use a second macro suffixed with OS constant}}
{{:: {{VAR=validAction}}INCLUDE( $Glossaire/INCLUDE/attachments/include_pdf.{{OS}}.html ) }}

{{:: {{VAR=validAction}}SET_VAR(finalFilename, {{GET_DOSS_GUID}}__{{DATE=yyyyMMdd}}_{{HeureCourante=hhmmss}}_{{USER LOGIN MEDECIN}}.pdf)}}

{{:: {{VAR=validAction}}copy_file($ToAbsPath {{VAR=tmpFiles}}/include_pdf.tmp.pdf, $ToAbsPath{{VAR=PatientFiles}}/{{VAR=finalFilename}}, $remove_src_file)}}
{{:: {{VAR=validAction}}SI(S,{{VAR=PatientFiles}}/{{VAR=finalFilename}},=,,FLAG_FALSE,)&gt;validAction}}
{{:: {{VAR=popupText}}(S,{{VAR=validAction}},=,FLAG_FALSE,ERREUR !!! Problème lors de la copie du fichier,TEST)&gt;popupText}}

{{REM= insert in database}}
{{:: {{VAR=validAction}}SQL_WRITE(Attachments, ,PrimKey,,Doc_PK,{{:: SQL_GET_RUB_HEAD_PK()}},File_Name,{{VAR=finalFilename}},Doc_Name,{{VAR=docName}},Date,{{DT=yyyy-MM-dd hh:mm:ss}})}}
{{REM= we reset agendaPK in case it was filled by a previous macro}}
{{:: {{VAR=validAction}}SET_VAR(sqlTest,0)}}
{{REM= we test if if sql_write worked}}
{{:: {{VAR=validAction}}SQL_SELECT( Attachments , PrimKey , WHERE Date='{{DT=yyyy-MM-dd hh:mm:ss}}' AND File_Name='{{VAR=finalFilename}}',20,%, ,%0)&gt;sqlTest}}
{{:: {{VAR=validAction}}TEST(N,{{VAR=sqlTest}},>,0,,FLAG_FALSE)&gt;validAction}}
{{:: {{VAR=popupText}}(S,{{VAR=validAction}},=,FLAG_FALSE,ERREUR DB:attachments !!! Veuillez contacter l'administrateur,TEST)&gt;popupText}}

{{REM= We format finalFilename in white color so it won't be displayed}}
{{::# {{VAR=validAction}}SET_VAR(localAccess,<span style="font-family:Fixed;font-size:9pt;font-weight:600;text-decoration:underline;color:#0000ff">Clic droit pour voir ce fichier PDF &#40;accès local&#41;</span>  <span style="font-family:Fixed;font-size:9pt;font-weight:600;color:#ffffff">{{VAR=finalFilename}}</span><br />)}}
{{REM= ###TODO### remote access}}
{{::# {{VAR=validAction}}SET_VAR(remoteAccess,<span style="font-family:Fixed;font-size:9pt;font-weight:600;text-decoration:underline;color:#0000ff">Clic droit pour voir ce fichier PDF &#40;accès distant&#41;</span>  <span style="font-family:Fixed;font-size:9pt;font-weight:600;color:#ffffff">{{VAR=finalFilename}}</span><br /><hr><br />)}}


{{REM= If validAction was filled we display a message to help troubleshooting}}
{{:: TEST(S,{{VAR=validAction}},=,FLAG_FALSE,MESSAGE_POPUP,)&gt;doPopup}}
{{:: {{VAR=doPopup}}({{VAR=popupText}},,{{VAR=popupFading}})}}

{{:: WAIT_CURSOR (RESTORE) }}
</p>
</body>
</html>
